CREATE OR REPLACE FUNCTION id_generator(prefix varchar)
RETURNS VARCHAR
LANGUAGE SQL AS
$$
SELECT (prefix || '-' || EXTRACT(EPOCH FROM (SELECT current_timestamp AT TIME ZONE 'UTC')) *100000 || '-' || (random()*10000)::integer);
$$;

CREATE TABLE Employee (
    eid VARCHAR(29) PRIMARY KEY DEFAULT id_generator('EMPLOYEE'),
    firstname VARCHAR(45) NOT NULL,
    lastname VARCHAR(45) NOT NULL,
    street VARCHAR(128) NOT NULL,
    post_code VARCHAR(16) NOT NULL,
    city VARCHAR(128) NOT NULL,
    country VARCHAR(128) NOT NULL,
    email VARCHAR(128) NOT NULL UNIQUE,
    remaining_leave REAL DEFAULT 25.0,
    position VARCHAR(45),
    password TEXT
);

CREATE TABLE HR (
    eid VARCHAR(29) PRIMARY KEY,
    FOREIGN KEY (eid) REFERENCES Employee(eid)
);

CREATE TABLE TeamLeader (
    eid VARCHAR(29) PRIMARY KEY,
    FOREIGN KEY (eid) REFERENCES Employee(eid)
);

CREATE TABLE HRD (
    eid VARCHAR(29) PRIMARY KEY,
    FOREIGN KEY (eid) REFERENCES Employee(eid)
);


CREATE TABLE Department (
    id VARCHAR(31) PRIMARY KEY DEFAULT id_generator('DEPARTMENT'),
    name VARCHAR(45) NOT NULL UNIQUE
);

CREATE TABLE Team (
    id VARCHAR(25) PRIMARY KEY DEFAULT id_generator('TEAM'),
    name VARCHAR(45) NOT NULL,
    dept_id VARCHAR(31) NOT NULL,
    leader_id VARCHAR(29) NOT NULL,
    FOREIGN KEY (dept_id) REFERENCES Department(id),
    FOREIGN KEY (leader_id) REFERENCES TeamLeader(eid)
);

CREATE TABLE EmployeeTeam (
    eid VARCHAR(29),
    team_id VARCHAR(25),
    PRIMARY KEY (eid, team_id),
    FOREIGN KEY (eid) REFERENCES Employee(eid),
    FOREIGN KEY (team_id) REFERENCES Team(id)
);

CREATE TABLE TypeOfLeave (
    id VARCHAR(32) PRIMARY KEY DEFAULT id_generator('TYPEOFLEAVE'),
    name VARCHAR(45) NOT NULL,
    description VARCHAR(255),
    is_archived BOOLEAN DEFAULT FALSE
);

CREATE TYPE LEAVE_STATUS AS ENUM ('PENDING', 'CANCELLED', 'ACCEPTED', 'DECLINED');

CREATE TABLE LeaveRequest (
    lrid VARCHAR(33) PRIMARY KEY DEFAULT id_generator('LEAVEREQUEST'),
    reason TEXT,
    status LEAVE_STATUS DEFAULT 'PENDING',
    creation_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT (current_timestamp AT TIME ZONE 'UTC'),
    last_edition_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT (current_timestamp AT TIME ZONE 'UTC'),
    starting_date TIMESTAMP WITH TIME ZONE NOT NULL,
    ending_date TIMESTAMP WITH TIME ZONE NOT NULL,
    hr_comment TEXT,
    eid VARCHAR(29) NOT NULL,
    type_id VARCHAR(32) NOT NULL,
    FOREIGN KEY (eid) REFERENCES Employee(eid),
    FOREIGN KEY (type_id) REFERENCES TypeOfLeave(id)
);


/*==== INSERT ====*/

INSERT INTO Employee (eid, firstname, lastname, street, post_code, city, country, email, position, password) VALUES
('EMPLOYEE-157314099170606-0001', 'Tony','Stark','9 rue du chene germain','22700','Lannion','France','tony.stark@marvel.com','Director','ea181033360f35a6a7c48c50126f851a4e6c1da4916f8ec35a610c39405b7016d6d8b7e76b63d0196b446a97e8d984c246cfb0a82b5b5be5048d75095fdd4efc'),
('EMPLOYEE-157314099170606-0002', 'Thor','Odinson','5 avenue Asgardian ','22700','Lannion','France','thor@marvel.com','God','ac6126415e8804b0f9b40d190efdbe1732b81c1ae0a2c025b82c888d6ff07c4c6bebdf50c6811e4842e4355eeb4560aafe59f18227cb36151267c5533c157a70'),
('EMPLOYEE-157314099170606-0003', 'Henry','Jonathan','rue','0000','Nebraska','USA','antman@marvel.com','Ant-man','544e45c9eb1ee0aca7380b6563f0c366743f6e53c381089df221fd06c16b6ec7b8ae7070ccf252c39d63db79d96a24927bb8175fc0877f6e4f484f9927422a25'),
('EMPLOYEE-157314099170606-0004', 'Bruce','Banner','9 rue du labo','58695','Secret','USA','hulk@marvel.com','doctor','d6693633bf12ca35258b3b91ab27e0996b0e1f1c5d6f4572461138f662696aa35d9c4cf135c1b861a99fa2db8c51a815551b700cef1aec033b79649f9a399e44'),
('EMPLOYEE-157314099170606-0005', 'Steve','Rogers','0 rue du pole nord','0000','PoleNord','Danemark','captain@marvel.com','Captain America','be544f75277c1c2c2eb1f7192e7104a47671ce6ec625f798964cbbadaca112edb29ef62b2d10ad527d8bf2d07e06285c3f1619026a3b9bedae8a472d265c0d2e'),
('EMPLOYEE-157314099170606-0006', 'Clinton','Barton','5 branche','124578','Arbre','Terre','hawkeye@marvel.com','Hawkeye','c168ce1ef8b634999fcf4da16134283b861bba7ad523f57b9c04345e32390887c0e355bb45c0fa58a7b238f1c75f2e90d7d932ab369ade8df16096586b571453'),
('EMPLOYEE-157314099170606-0007', 'T','Challa','1 tour','1234','Wakanda','Africa','blackpanther@marvel.com','Black Panther','af1ddfaa4c9612dff1584da900eae7a050cb4c326eeabeb3f1ac3674faf280af85cf79050a61c4a659ea3e05fd3f555804377b31abc3af6a69e9a2a116537f13'),
('EMPLOYEE-157314099170606-0008', 'Natasha','Romanoff','1 rue du fantome','4569','Moscou','Russie','blackwidow@marvel.com','Black Widow','7bc591713ef8bbfb667587a0586923cc0cc6ddf67c7eb5493c206731af85699788f03cd00c2629b55ec634da49d005b388756a611add4bbe1db471fb6a2f79fe'),
('EMPLOYEE-157314099170606-0009', 'Monica','Rambeau','partout','00','dans la','Galaxie','captainmarvel@marvel.com','Captain Marvel','b160d14001db050d19d32ac3c4850f3e03085fab749eaa11d7b4596b1b25ec2bbe3682ad39c22042217407d642d494abcc82658fae20738dde296ea38ca262e3'),
('EMPLOYEE-157314099170606-0010', 'Peter','Parker','quelque part','000','New York','USA','spiderman@marvel.com','Spider Man','7ab6888935567386376037e042524d27fc8a24ef87b1944449f6a0179991dbdbc481e98db4e70f6df0e04d1a69d8e7101d881379cf1966c992100389da7f3e9a');

INSERT INTO HR VALUES
('EMPLOYEE-157314099170606-0006'),
('EMPLOYEE-157314099170606-0008');

INSERT INTO TeamLeader VALUES
('EMPLOYEE-157314099170606-0002'),
('EMPLOYEE-157314099170606-0005'),
('EMPLOYEE-157314099170606-0001'),
('EMPLOYEE-157314099170606-0007');

INSERT INTO HRD VALUES
('EMPLOYEE-157314099170606-0001'),
('EMPLOYEE-157314099170606-0002');

INSERT INTO Department (id, name) VALUES
('DEPARTMENT-157314099170606-0001', 'Space'),
('DEPARTMENT-157314099170606-0002', 'Recherche'),
('DEPARTMENT-157314099170606-0003', 'R&D');

INSERT INTO Team (id, name, dept_id, leader_id) VALUES
('TEAM-157314099170606-0001', 'Stark corporation', 'DEPARTMENT-157314099170606-0003', 'EMPLOYEE-157314099170606-0001'),
('TEAM-157314099170606-0002', 'Bifrost traveler', 'DEPARTMENT-157314099170606-0001', 'EMPLOYEE-157314099170606-0002'),
('TEAM-157314099170606-0003', 'Frozen', 'DEPARTMENT-157314099170606-0002', 'EMPLOYEE-157314099170606-0005'),
('TEAM-157314099170606-0004', 'Wakanda team', 'DEPARTMENT-157314099170606-0003', 'EMPLOYEE-157314099170606-0007');

INSERT INTO EmployeeTeam (eid, team_id) VALUES
('EMPLOYEE-157314099170606-0001','TEAM-157314099170606-0001'),
('EMPLOYEE-157314099170606-0003','TEAM-157314099170606-0001'),
('EMPLOYEE-157314099170606-0004','TEAM-157314099170606-0001'),
('EMPLOYEE-157314099170606-0010','TEAM-157314099170606-0001'),
('EMPLOYEE-157314099170606-0002','TEAM-157314099170606-0002'),
('EMPLOYEE-157314099170606-0009','TEAM-157314099170606-0002'),
('EMPLOYEE-157314099170606-0005','TEAM-157314099170606-0003'),
('EMPLOYEE-157314099170606-0006','TEAM-157314099170606-0003'),
('EMPLOYEE-157314099170606-0008','TEAM-157314099170606-0003'),
('EMPLOYEE-157314099170606-0007','TEAM-157314099170606-0004'),
('EMPLOYEE-157314099170606-0005','TEAM-157314099170606-0004');

INSERT INTO TypeOfLeave (name, description) VALUES
('CA', 'Congés Annuels'),
('RTT', 'Réduction du temps de travail'),
('Familliale', 'enfants, etc..');